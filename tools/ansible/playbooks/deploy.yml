---
# DRS Validator - Application Deployment
# Equivalente a deploy.py - despliegue r√°pido de la aplicaci√≥n

- name: DRS Application Deployment
  hosts: all
  become: false
  gather_facts: false

  tasks:
  - name: Display deployment information
    debug:
      msg: |
        ================================================
        üöÄ DRS Application Deployment
        ================================================
        Host: {{ ansible_host }}
        Port: {{ app_port }}
        Branch: {{ git_branch }}
        Directory: {{ app_dir }}
        ================================================

  - name: Clone or update repository
    git:
      repo: "{{ git_repo }}"
      dest: "{{ app_dir }}"
      version: "{{ git_branch }}"
      force: yes

  - name: Configure port in docker-compose.yml
    replace:
      path: "{{ app_dir }}/docker-compose.yml"
      regexp: '- "[0-9]*:8089"'
      replace: '- "{{ app_port }}:8089"'

  - name: Stop existing containers
    command: docker compose down
    args:
      chdir: "{{ app_dir }}"
    ignore_errors: yes

  - name: Build and start containers
    command: docker compose up -d --build
    args:
      chdir: "{{ app_dir }}"

  - name: Wait for service to be ready
    wait_for:
      port: "{{ app_port }}"
      delay: 5
      timeout: 60

  - name: Verify deployment - API test
    uri:
      url: "http://{{ ansible_host }}:{{ app_port }}/api/test"
      method: GET
      status_code: 200
      timeout: 10
    register: api_test
    ignore_errors: yes

  - name: Verify deployment - Health check (fallback)
    uri:
      url: "http://{{ ansible_host }}:{{ app_port }}/health"
      method: GET
      status_code: 200
      timeout: 10
    register: health_check
    when: api_test is failed

  - name: Show container status
    command: docker compose ps
    args:
      chdir: "{{ app_dir }}"
    register: containers
    changed_when: false

  - name: Display deployment results
    debug:
      msg: |
        ================================================
        ‚úÖ Deployment completado!
        ================================================
        üåê Web UI: http://{{ ansible_host }}:{{ app_port }}
        üìä API Docs: http://{{ ansible_host }}:{{ app_port }}/docs
        üè• Health: http://{{ ansible_host }}:{{ app_port }}/health
        ================================================
        Container Status:
        {{ containers.stdout }}
        ================================================
        API Test: {{ '‚úÖ OK' if api_test.status == 200 else '‚ö†Ô∏è Failed' }}
        Health Check: {{ '‚úÖ OK' if health_check.status == 200 else '‚ö†Ô∏è Failed' }}
        ================================================
